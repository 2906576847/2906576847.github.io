<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pexels Category Videos</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #media-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        #media-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.3) 0%, transparent 100px);
        }
        #video-bg, #image-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #controls {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0;
            transition: all 0.3s ease;
            background: rgba(28,28,30,0.8);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 80vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        #controls.show {
            opacity: 1;
        }
        
            #toggle-menu {
                all: initial; /* 重置所有默认样式 */
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: rgba(28,28,30,0.9);
                color: white;
                font: 24px -apple-system, BlinkMacSystemFont, sans-serif;
                z-index: 101;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                outline: none;
                cursor: pointer;
                transition: all 0.2s ease;
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                line-height: 60px;
                text-align: center;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                /* 强制尺寸 */
                min-width: 60px !important;
                min-height: 60px !important;
                max-width: 60px !important;
                max-height: 60px !important;
                /* 防止缩放影响 */
                transform: none !important;
                /* 防止flex布局影响 */
                flex: 0 0 60px !important;
            }
            
            @media (max-width: 768px) {
                #toggle-menu {
                    /* 确保移动端样式优先级 */
                    all: unset !important;
                    position: fixed !important;
                    bottom: 20px !important;
                    right: 20px !important;
                    width: 60px !important;
                    height: 60px !important;
                    border-radius: 50% !important;
                    background: rgba(28,28,30,0.9) !important;
                    color: white !important;
                    font: 24px -apple-system, BlinkMacSystemFont, sans-serif !important;
                    z-index: 101 !important;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    border: none !important;
                    outline: none !important;
                    cursor: pointer !important;
                    box-sizing: border-box !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    line-height: 60px !important;
                    text-align: center !important;
                }
            }
        
        @media (max-width: 768px) {
            #controls {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 85vh;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                padding: 20px 15px;
                opacity: 1;
                pointer-events: none;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 12px;
                box-sizing: border-box;
            }
            
            #controls.show {
                transform: translateY(0);
                pointer-events: all;
            #toggle-menu {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: rgba(28,28,30,0.9);
                color: white;
                font-size: 24px;
                z-index: 101;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                display: none; /* 默认隐藏 */
                align-items: center;
                justify-content: center;
                border: none;
                outline: none;
                cursor: pointer;
                transition: all 0.2s ease;
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                line-height: 60px;
                text-align: center;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            @media (max-width: 768px) {
                #toggle-menu {
                    /* 确保移动端样式优先级 */
                    display: flex !important;
                }
            }
            
            #toggle-menu:active {
                transform: scale(0.95);
                background: rgba(28,28,30,1);
            }
            
            button, select {
                width: 100%;
                padding: 14px 12px;
                font-size: 15px;
                margin: 0;
                box-sizing: border-box;
            }
            
            #controls > div {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            #interval-input {
                width: 100%;
                padding: 14px 12px;
                box-sizing: border-box;
            }
            
            /* 自定义查询框样式 */
            #custom-query {
                width: 100%;
                padding: 14px 12px;
                box-sizing: border-box;
                border-radius: 8px;
                border: none;
                background: rgba(120,120,128,0.2);
                color: white;
                font-size: 15px;
            }
        }
        button, select {
            background: rgba(120,120,128,0.2);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            transition: all 0.2s;
            min-width: 120px;
            text-align: center;
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 36px;
        }
        select option {
            background: #1c1c1e;
        }
        button:hover {
            background: rgba(120,120,128,0.3);
        }
        button:active {
            transform: scale(0.96);
        }
        #interval-input {
            background: rgba(120,120,128,0.2);
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            width: 80px;
        }
        #info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            max-width: 300px;
            opacity: 0;
            transition: opacity 0.3s;
            background: linear-gradient(to right, rgba(0,0,0,0.7), transparent);
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
        }
        body:hover #info {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="media-container">
        <video id="video-bg" autoplay muted loop style="display:none;"></video>
        <img id="image-bg" style="display:none; width:100%; height:100%; object-fit:cover;">
    </div>
    
        <div id="info" style="display:none;"></div>
    
    <button id="toggle-menu">☰</button>
    <div id="controls">
        <div style="display: flex; gap: 8px;">
            <select id="category-select">
                <option value="nature">Nature</option>
                <option value="ocean">Ocean</option>
                <option value="landscape">Landscape</option>
                <option value="city">City</option>
                <option value="animals">Animals</option>
                <option value="custom">Custom</option>
            </select>
            <input type="text" id="custom-query" placeholder="Enter keywords..." style="display: none;">
            <button id="search-btn" style="display: none;">Search</button>
        </div>
        <button id="prev-btn">Previous</button>
        <button id="next-btn">Next</button>
        <button id="loop-btn">Loop: Off</button>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button id="toggle-auto-btn">Auto Switch: On</button>
            <input type="number" id="interval-input" placeholder="Hours" min="0.1" step="0.1" value="0.5" style="width: 80px;">
            <button id="set-interval-btn">Set</button>
        </div>
        <select id="media-type-select">
            <option value="videos">Videos</option>
            <option value="photos">Photos</option>
        </select>
        <select id="quality-select">
            <option value="sd">SD</option>
            <option value="hd" selected>HD</option>
            <option value="uhd">UHD</option>
        </select>
    </div>

    <script>
        // 多个Pexels API密钥，每次随机使用一个
        const API_KEYS = [
            '563492ad6f917000010000019b983f3b62fe43daa92e746d4553dd35',
            'LmimnbcCCFaWU7wgWSua5vVWVmONrzv8xKKtfXhU9c39TLMYIeSf7UOD',
            'p1p0I9iC7ChShttx4Z29WDLsyfW6V6mSm05l0cE0evnxyYckEdCFqkEl',
            'Jy1mnvk6Yb3OmlkH6VnfCO95yOGGELCAi0pvq9QNsPFLz0u3fTTez1hh',
            'RHCHpYa7xVhGqDxMtDbEd9aFCyrTAAg4EHhot3rdlkLyWAtXFjE6hHsD',
            'tR1sh3nlY8aPATAcLApPg3odWO7Fjg5WmeSXjWv9MA3nWFTdIFQH0O39'
            
        ];
        
        // 获取随机API密钥
        function getRandomApiKey() {
            if (API_KEYS.length === 0) {
                throw new Error('No API keys configured');
            }
            const randomIndex = Math.floor(Math.random() * API_KEYS.length);
            return API_KEYS[randomIndex];
        }
        let currentMediaIndex = 0;
        let mediaItems = [];
        let autoSwitchInterval;
        let isAutoSwitch = true;
        let isLoopCurrent = false;
        let currentPage = 1;
        let isLoading = false;
        let currentCategory = 'nature';
        let switchIntervalHours = 0.5; // 默认0.5小时
        let mediaType = 'videos'; // 'videos' 或 'photos'
        
        // 保存设置到localStorage
        function saveSettings() {
            try {
                // 确保有有效的媒体数据
                if (mediaItems.length > 0 && currentMediaIndex >= 0) {
                    const currentMedia = mediaItems[currentMediaIndex];
                    if (!currentMedia) {
                        console.log('当前媒体项无效，不保存设置');
                        return;
                    }
                    
                    // 获取当前质量设置
                    const quality = document.getElementById('quality-select').value;
                    
                    // 构建设置对象
                    const settings = {
                        category: document.getElementById('category-select').value,
                        customQuery: document.getElementById('custom-query').value,
                        autoSwitch: isAutoSwitch,
                        loopCurrent: isLoopCurrent,
                        quality: quality,
                        switchIntervalHours: switchIntervalHours,
                        mediaType: document.getElementById('media-type-select').value,
                        currentMediaIndex: currentMediaIndex,
                        currentMediaUrl: mediaType === 'videos' 
                            ? (currentMedia.video_files.find(f => f.quality === quality)?.link || 
                               currentMedia.video_files?.[0]?.link)
                            : (currentMedia.src?.large2x || currentMedia.src?.original || ''),
                        timestamp: new Date().toISOString() // 添加时间戳用于调试
                    };
                    
                    // 保存到本地存储
                    localStorage.setItem('pexelsVideoSettings', JSON.stringify(settings));
                    
                    console.log('设置已保存:', {
                        ...settings,
                        currentMediaUrl: settings.currentMediaUrl ? '存在' : '不存在' // 简化日志
                    });
                } else {
                    console.log('没有有效的媒体数据，不保存设置');
                }
            } catch (error) {
                console.error('保存设置失败:', error);
            }
        }

        // 从localStorage加载设置
        function loadSettings() {
            const saved = localStorage.getItem('pexelsVideoSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('category-select').value = settings.category;
                document.getElementById('quality-select').value = settings.quality;
                document.getElementById('media-type-select').value = settings.mediaType || 'videos';
                isAutoSwitch = settings.autoSwitch;
                isLoopCurrent = settings.loopCurrent;
                switchIntervalHours = settings.switchIntervalHours || 0.5;
                mediaType = settings.mediaType || 'videos';
                currentMediaIndex = settings.currentMediaIndex || 0;
                
                // 更新UI状态
                document.getElementById('toggle-auto-btn').textContent = `Auto Switch: ${isAutoSwitch ? 'On' : 'Off'}`;
                document.getElementById('loop-btn').textContent = `Loop: ${isLoopCurrent ? 'On' : 'Off'}`;
                document.getElementById('interval-input').value = switchIntervalHours;
                
                // 处理自定义查询显示
                const showCustom = settings.category === 'custom';
                document.getElementById('custom-query').style.display = showCustom ? 'block' : 'none';
                document.getElementById('search-btn').style.display = showCustom ? 'block' : 'none';
                if (showCustom) {
                    document.getElementById('custom-query').value = settings.customQuery || '';
                }
                
                // 如果有保存的媒体URL，立即显示
                if (settings.currentMediaUrl) {
                    const videoBg = document.getElementById('video-bg');
                    const imageBg = document.getElementById('image-bg');
                    
                    if (mediaType === 'videos') {
                        videoBg.src = settings.currentMediaUrl;
                        videoBg.style.display = 'block';
                        imageBg.style.display = 'none';
                        videoBg.load();
                        videoBg.play().catch(e => console.log('自动播放被阻止:', e));
                    } else {
                        imageBg.src = settings.currentMediaUrl;
                        imageBg.style.display = 'block';
                        videoBg.style.display = 'none';
                    }
                    
                    // 确保媒体元素可见
                    document.getElementById('media-container').style.display = 'block';
                }
                
                return true; // 表示有保存的状态
            }
            return false; // 没有保存的状态
        }

        // 初始化
        window.onload = async function() {
            // 先加载设置
            const hasSavedState = loadSettings();
            setupControls();
            
            // 如果有保存的状态，优先恢复
            if (hasSavedState) {
                const saved = JSON.parse(localStorage.getItem('pexelsVideoSettings'));
                
                // 1. 立即显示保存的媒体内容
                if (saved.currentMediaUrl) {
                    const videoBg = document.getElementById('video-bg');
                    const imageBg = document.getElementById('image-bg');
                    
                    if (saved.mediaType === 'videos') {
                        videoBg.src = saved.currentMediaUrl;
                        videoBg.style.display = 'block';
                        imageBg.style.display = 'none';
                        videoBg.load();
                        videoBg.play().catch(e => console.log('自动播放被阻止:', e));
                    } else {
                        imageBg.src = saved.currentMediaUrl;
                        imageBg.style.display = 'block';
                        videoBg.style.display = 'none';
                    }
                    
                    document.getElementById('media-container').style.display = 'block';
                }
                
                // 2. 获取新内容但不重置播放位置
                await fetchMedia(1, true);
                
                // 3. 恢复播放位置
                if (saved.currentMediaIndex !== undefined && mediaItems.length > saved.currentMediaIndex) {
                    playMedia(saved.currentMediaIndex);
                }
            } else {
                // 没有保存状态，正常初始化
                await fetchMedia();
            }
            
            if (isAutoSwitch) startAutoSwitch();
        };

        async function fetchMedia(page = 1, preservePosition = false) {
            if (isLoading) return;
            isLoading = true;
            
            try {
                // ... [保持原有API请求代码不变] ...
                
                if (page === 1) {
                    if (preservePosition) {
                        // 保留现有媒体项，添加新项到数组开头
                        mediaItems = [...mediaData, ...mediaItems];
                    } else {
                        mediaItems = mediaData;
                        playMedia(0);
                    }
                } else {
                    mediaItems = [...mediaItems, ...mediaData];
                    playMedia(currentMediaIndex);
                }
                
                currentPage = page;
                saveSettings(); // 每次获取新内容后保存状态
            } catch (error) {
                console.error('获取媒体内容失败:', error);
            } finally {
                isLoading = false;
            }
        }

        // 初始化
        window.onload = async function() {
            // 1. 先加载设置
            const hasSavedState = loadSettings();
            setupControls();
            
            // 2. 如果有保存的状态
            if (hasSavedState) {
                const saved = JSON.parse(localStorage.getItem('pexelsVideoSettings'));
                console.log('恢复保存的状态:', saved);
                
                // 2.1 立即显示保存的媒体内容
                if (saved.currentMediaUrl) {
                    const videoBg = document.getElementById('video-bg');
                    const imageBg = document.getElementById('image-bg');
                    
                    if (saved.mediaType === 'videos') {
                        videoBg.src = saved.currentMediaUrl;
                        videoBg.style.display = 'block';
                        imageBg.style.display = 'none';
                        videoBg.load();
                        videoBg.play().catch(e => console.log('自动播放被阻止:', e));
                    } else {
                        imageBg.src = saved.currentMediaUrl;
                        imageBg.style.display = 'block';
                        videoBg.style.display = 'none';
                    }
                    
                    document.getElementById('media-container').style.display = 'block';
                }
                
                // 2.2 获取新内容但不重置播放位置
                await fetchMedia(1, true);
                
                // 2.3 恢复播放位置
                if (saved.currentMediaIndex !== undefined && mediaItems.length > 0) {
                    const safeIndex = Math.min(saved.currentMediaIndex, mediaItems.length - 1);
                    console.log('恢复播放位置:', safeIndex);
                    playMedia(safeIndex);
                } else if (mediaItems.length > 0) {
                    console.log('恢复默认播放位置: 0');
                    playMedia(0);
                }
            } else {
                // 3. 没有保存状态，正常初始化
                console.log('没有保存的状态，全新初始化');
                await fetchMedia();
            }
            
            if (isAutoSwitch) startAutoSwitch();
            
            // 4. 确保最终有内容显示
            if (mediaItems.length === 0) {
                console.log('没有获取到媒体内容，重试...');
                await fetchMedia();
            }
            
            // 5. 确保保存当前状态
            saveSettings();
        };
        
        async function fetchMedia(page = 1) {
            if (isLoading) return;
            isLoading = true;
            console.log('开始获取媒体内容...');
            currentCategory = document.getElementById('category-select').value;
            mediaType = document.getElementById('media-type-select').value;
            let query = currentCategory;
            console.log(`请求参数: 类型=${mediaType}, 分类=${currentCategory}, 页码=${page}`);
            
            if (currentCategory === 'custom') {
                const customQuery = document.getElementById('custom-query').value.trim();
                if (!customQuery) return;
                query = customQuery;
            }
            
            try {
                // 已移除描述信息，不再需要设置textContent
                let apiUrl;
                if (mediaType === 'videos') {
                    apiUrl = `https://api.pexels.com/videos/search?query=${encodeURIComponent(query)}&per_page=10&page=${page}`;
                } else {
                    apiUrl = `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=10&page=${page}`;
                }
                
                console.log(`正在请求URL: ${apiUrl}`);
                let response;
                let retryCount = 0;
                const maxRetries = API_KEYS.length;
                
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            headers: {
                                'Authorization': getRandomApiKey()
                            }
                        });
                        console.log(`响应状态: ${response.status}`);
                        
                        if (!response.ok) {
                            if (response.status === 429) {
                                console.warn(`API配额限制，尝试第${retryCount + 1}次重试`);
                                retryCount++;
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                continue;
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const apiResponse = await response.json();
                        console.log('API完整响应:', apiResponse);
                        
                        // 严格验证响应格式
                        if (!apiResponse || typeof apiResponse !== 'object') {
                            throw new Error('无效的API响应: 非对象格式');
                        }
                        
                        let mediaData;
                        if (mediaType === 'videos') {
                            if (!apiResponse.videos || !Array.isArray(apiResponse.videos)) {
                                throw new Error('无效的视频数据格式');
                            }
                            mediaData = apiResponse.videos;
                        } else {
                            if (!apiResponse.photos || !Array.isArray(apiResponse.photos)) {
                                throw new Error('无效的图片数据格式');
                            }
                            mediaData = apiResponse.photos;
                        }
                        
                        if (mediaData.length === 0) {
                            throw new Error('API返回空数据集');
                        }
                        
                        if (page === 1) {
                            // 如果是第一页且没有保存的状态，才重置播放位置
                            if (!localStorage.getItem('pexelsVideoSettings')) {
                                mediaItems = mediaData;
                                playMedia(0);
                            } else {
                                // 保留现有媒体项，添加新项到数组开头
                                mediaItems = [...mediaData, ...mediaItems];
                            }
                        } else {
                            mediaItems = [...mediaItems, ...mediaData];
                            playMedia(currentMediaIndex);
                        }
                        currentPage = page;
                        break; // 成功则退出重试循环
                        
                    } catch (error) {
                        console.error(`请求失败(尝试${retryCount + 1}/${maxRetries}):`, {
                            url: apiUrl,
                            error: error.message,
                            stack: error.stack
                        });
                        
                        if (retryCount < maxRetries - 1) {
                            retryCount++;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        } else {
                            console.error('所有API密钥尝试失败');
                            throw error;
                        }
                    }
                }
                
                // 这部分代码已被移除，因为data变量在重试循环中已处理
            } catch (error) {
                console.error('获取媒体内容失败:', {
                    type: mediaType,
                    category: currentCategory,
                    page: page,
                    error: error.message,
                    stack: error.stack
                });
                
                // 显示最后一个可用的媒体内容
                if (mediaItems.length > 0) {
                    playMedia(currentMediaIndex);
                } else {
                    console.error('没有可用的媒体内容');
                }
            } finally {
                isLoading = false;
            }
        }
        
        function playMedia(index) {
            if (!mediaItems.length) {
                console.log('没有可播放的媒体内容');
                return;
            }
            
            // 确保索引在有效范围内
            const safeIndex = Math.max(0, Math.min(index, mediaItems.length - 1));
            
            // 检查是否需要加载更多媒体
            if (index >= mediaItems.length && !isLoading) {
                fetchMedia(currentPage + 1);
                currentMediaIndex = mediaItems.length - 1;
                return;
            }
            
            currentMediaIndex = (safeIndex + mediaItems.length) % mediaItems.length;
            const currentMedia = mediaItems[currentMediaIndex];
            
            // 立即更新显示
            const videoBg = document.getElementById('video-bg');
            const imageBg = document.getElementById('image-bg');
            
            if (mediaType === 'videos') {
                const quality = document.getElementById('quality-select').value;
                let videoFile = currentMedia.video_files.find(f => f.quality === quality) || currentMedia.video_files[0];
                
                // 确保视频源变化时才重新加载
                if (videoBg.src !== videoFile.link) {
                    videoBg.src = videoFile.link;
                    videoBg.load();
                }
                videoBg.style.display = 'block';
                imageBg.style.display = 'none';
                videoBg.play().catch(e => console.log('自动播放被阻止:', e));
            } else {
                const newSrc = currentMedia.src.large2x || currentMedia.src.original;
                // 确保图片源变化时才重新加载
                if (imageBg.src !== newSrc) {
                    imageBg.src = newSrc;
                }
                imageBg.style.display = 'block';
                videoBg.style.display = 'none';
            }
            
            saveSettings(); // 每次播放新内容时保存状态
        }
        
        function updateMediaInfo() {
            const media = mediaItems[currentMediaIndex];
            const videoBg = document.getElementById('video-bg');
            const imageBg = document.getElementById('image-bg');
            
            if (mediaType === 'videos') {
                const quality = document.getElementById('quality-select').value;
                // 优先获取适合移动设备的视频质量
                let videoFile = media.video_files.find(file => file.quality === quality);
                if (!videoFile) {
                    const qualityOrder = ['hd', 'sd', 'uhd']; // 优先HD而非UHD
                    for (const q of qualityOrder) {
                        videoFile = media.video_files.find(file => file.quality === q);
                        if (videoFile) break;
                    }
                    videoFile = videoFile || media.video_files[0];
                }
                
                // 创建临时video元素进行预加载
                const tempVideo = document.createElement('video');
                tempVideo.oncanplay = function() {
                    // 新内容加载完成后直接替换src，保持当前显示
                    videoBg.src = videoFile.link;
                    videoBg.oncanplay = function() {
                        updateMediaMetadata(media, videoFile);
                    };
                    videoBg.load();
                };
                tempVideo.src = videoFile.link;
                tempVideo.load();
            } else {
                // 创建临时image元素进行预加载
                const tempImg = new Image();
                tempImg.onload = function() {
                    // 新内容加载完成后直接替换src，保持当前显示
                    imageBg.src = tempImg.src;
                    imageBg.onload = function() {
                        updateMediaMetadata(media);
                    };
                };
                tempImg.src = media.src.large2x || media.src.large || media.src.medium || media.src.original;
            }
        }
        
        function updateMediaMetadata(media, videoFile = null) {
            const videoBg = document.getElementById('video-bg');
            const imageBg = document.getElementById('image-bg');
            
            if (mediaType === 'videos') {
                videoBg.style.display = 'block';
                imageBg.style.display = 'none';
            } else {
                videoBg.style.display = 'none';
                imageBg.style.display = 'block';
            }
        }
        
        function setupControls() {
            // 菜单切换按钮
            document.getElementById('toggle-menu').addEventListener('click', function(e) {
                e.stopPropagation();
                const controls = document.getElementById('controls');
                controls.classList.toggle('show');
            });
            
            // 点击外部区域收起菜单
            document.addEventListener('click', function(e) {
                const controls = document.getElementById('controls');
                const toggleBtn = document.getElementById('toggle-menu');
                if (!controls.contains(e.target) && e.target !== toggleBtn) {
                    controls.classList.remove('show');
                }
            });
            
            document.getElementById('prev-btn').addEventListener('click', () => {
                if (isAutoSwitch) toggleAutoSwitch();
                playMedia(currentMediaIndex - 1);
            });
            
            document.getElementById('next-btn').addEventListener('click', () => {
                if (isAutoSwitch) toggleAutoSwitch();
                playMedia(currentMediaIndex + 1);
            });
            
            document.getElementById('toggle-auto-btn').addEventListener('click', toggleAutoSwitch);
            document.getElementById('loop-btn').addEventListener('click', toggleLoopCurrent);
            document.getElementById('quality-select').addEventListener('change', () => {
                updateMediaInfo();
            });
            document.getElementById('category-select').addEventListener('change', function() {
                const customQuery = document.getElementById('custom-query');
                const showCustom = this.value === 'custom';
                customQuery.style.display = showCustom ? 'block' : 'none';
                document.getElementById('search-btn').style.display = showCustom ? 'block' : 'none';
                if (!showCustom) {
                    currentPage = 1; // 重置页码
                    fetchMedia();
                }
                saveSettings();
            });
            
            document.getElementById('search-btn').addEventListener('click', function() {
                const query = document.getElementById('custom-query').value.trim();
                if (query) {
                    currentPage = 1; // 重置页码
                    fetchMedia().then(() => {
                        if (mediaItems.length > 0) {
                            playMedia(0);
                        }
                    });
                    saveSettings();
                }
            });
            
            document.getElementById('set-interval-btn').addEventListener('click', function() {
                const hours = parseFloat(document.getElementById('interval-input').value);
                if (hours && hours > 0) {
                    switchIntervalHours = hours;
                    if (isAutoSwitch) {
                        startAutoSwitch(); // 重新启动定时器
                    }
                    saveSettings();
                    alert(`Auto switch interval set to ${hours} hour(s)`);
                }
            });
        }
        
        function toggleAutoSwitch() {
            if (isLoopCurrent) {
                isLoopCurrent = false;
                document.getElementById('loop-btn').textContent = 'Loop: Off';
            }
            
            isAutoSwitch = !isAutoSwitch;
            document.getElementById('toggle-auto-btn').textContent = `Auto Switch: ${isAutoSwitch ? 'On' : 'Off'}`;
            
            if (isAutoSwitch) {
                startAutoSwitch();
            } else {
                clearInterval(autoSwitchInterval);
            }
            saveSettings();
        }

        function toggleLoopCurrent() {
            isLoopCurrent = !isLoopCurrent;
            document.getElementById('loop-btn').textContent = `Loop: ${isLoopCurrent ? 'On' : 'Off'}`;
            
            if (isLoopCurrent) {
                clearInterval(autoSwitchInterval);
                isAutoSwitch = false;
                document.getElementById('toggle-auto-btn').textContent = 'Auto Switch: Off';
            }
            saveSettings();
        }
        
        function startAutoSwitch() {
            clearInterval(autoSwitchInterval);
            if (isLoopCurrent) return;
            
            const intervalMs = switchIntervalHours * 60 * 60 * 1000; // 转换为毫秒
            autoSwitchInterval = setInterval(() => {
                const videoBg = document.getElementById('video-bg');
                const imageBg = document.getElementById('image-bg');
                
                // 确保当前媒体已加载完成
                if ((mediaType === 'videos' && videoBg.readyState >= 3) || 
                    (mediaType === 'photos' && imageBg.complete)) {
                    playMedia(currentMediaIndex + 1);
                }
            }, intervalMs);
        }
    </script>
</body>
</html>
